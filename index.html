<!DOCTYPE html>

<html lang="de">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<!-- include three.js -->
<script src='vendor/three.js/build/three.js'></script>
<script src='vendor/three.js/build/three.min.js'></script>
<script src='vendor/three.js/libs/stats.min.js'></script>

<!-- include js-aruco -->
<script src='vendor/js-aruco/svd.js'></script>
<script src='vendor/js-aruco/posit1-patched.js'></script>
<script src='vendor/js-aruco/cv.js'></script>
<script src='vendor/js-aruco/aruco.js'></script>

<!-- include some extensions -->
<script src='js/threex.webcamgrabbing.js'></script>
<script src='js/threex.imagegrabbing.js'></script>
<script src='js/threex.videograbbing.js'></script> 
<script src='js/threex.jsarucomarker.js'></script>
<script src="vendor/three.js/loaders/OBJLoader.js"></script>
</head>

<body style='margin: 0px; overflow: hidden;'>

<script>
	//////////////////////////////////////////////////////////////////////////////////
	//		Test if the browser support WebGL and getUserMedia
	//////////////////////////////////////////////////////////////////////////////////
	;(function(){
		// TODO backport those 2 in Detector.js
		var hasGetUserMedia = (navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia) ? true : false
		var hasMediaStreamTrackSources = MediaStreamTrack.getSources ? true : false
		var hasWebGL = ( function () { try { var canvas = document.createElement( 'canvas' ); return !! ( window.WebGLRenderingContext && ( canvas.getContext( 'webgl' ) || canvas.getContext( 'experimental-webgl' ) ) ); } catch ( e ) { return false; } } )()
		
		if( hasWebGL === false ){
			alert('your browser doesn\'t support navigator.getUserMedia()')			
		}
		if( hasMediaStreamTrackSources === false ){
			alert('your browser doesn\'t support MediaStreamTrack.getSources()')			
		}
		if( hasGetUserMedia === false ){
			alert('your browser doesn\'t support navigator.getUserMedia()')		
		}
	})()
	
	//////////////////////////////////////////////////////////////////////////////////
	//		enabled/disable various parts
	//////////////////////////////////////////////////////////////////////////////////
	var detectMarkersEnabled	= true
	var markerToObject3DEnabled	= true
	var webglRenderEnabled		= true

	//////////////////////////////////////////////////////////////////////////////////
	//		init Stats for detectMarkers
	//////////////////////////////////////////////////////////////////////////////////
	var detectMarkersStats = new Stats();
	detectMarkersStats.setMode( 1 );
	document.body.appendChild( detectMarkersStats.domElement );
        detectMarkersStats.domElement.style.position = 'absolute'
	detectMarkersStats.domElement.style.bottom = '0px'
	detectMarkersStats.domElement.style.right = '0px'

	var renderStats = new Stats();
	renderStats.setMode( 0 );
	document.body.appendChild( renderStats.domElement );
        renderStats.domElement.style.position = 'absolute'
	renderStats.domElement.style.bottom = '0px'
	renderStats.domElement.style.left = '0px'


	//////////////////////////////////////////////////////////////////////////////////
	//		Init
	//////////////////////////////////////////////////////////////////////////////////

	// init renderer
	var renderer	= new THREE.WebGLRenderer({
		antialias	: true,
		alpha		: true,
	});
	renderer.setSize( window.innerWidth, window.innerHeight );
	document.body.appendChild( renderer.domElement );

	// array of functions for the rendering loop
	var onRenderFcts = [];

	// init scene and camera
	var scene = new THREE.Scene()
	var camera	= new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 0.01, 1000);
	camera.position.z = 2;

	//////////////////////////////////////////////////////////////////////////////////
	//		create a markerObject3D
	//////////////////////////////////////////////////////////////////////////////////
	var markerObject3D = new THREE.Object3D()
	scene.add(markerObject3D)

	//////////////////////////////////////////////////////////////////////////////////
	//		add an object in the markerObject3D
	//////////////////////////////////////////////////////////////////////////////////

	;(function(){
		
				// LIGHTS
				var ambient = new THREE.AmbientLight( 0x404040 );
				scene.add( ambient );
				
				dirLight = new THREE.DirectionalLight( 0xffffff, 1 );
				dirLight.color.setHSL( 0, 0, 1 );
				dirLight.position.set( 2, 2, 2 );
				dirLight.position.multiplyScalar( 100 );
				scene.add(camera)
				camera.add( dirLight );
		
				// texture

				var manager = new THREE.LoadingManager();
				manager.onProgress = function ( item, loaded, total ) {

					console.log( item, loaded, total );

				};

				var texture = new THREE.Texture();

				var onProgress = function ( xhr ) {
					if ( xhr.lengthComputable ) {
						var percentComplete = xhr.loaded / xhr.total * 100;
						console.log( Math.round(percentComplete, 2) + '% downloaded' );
					}
				};

				var onError = function ( xhr ) {
				};


				var loader = new THREE.ImageLoader( manager );
				loader.load( 'tex/coffee.jpg', function ( image ) {

					texture.image = image;
					texture.needsUpdate = true;

				} );
				
				// model

				var loader = new THREE.OBJLoader( manager );
				loader.load( 'mod/coffee.obj', function ( object ) {
					object.traverse( function ( child ) {

						if ( child instanceof THREE.Mesh ) {

							child.material.map = texture;
						}

					} );
					//object.position.y = 0;
					object.scale.set( 0.01, 0.01, 0.01 );
					markerObject3D.add( object );

				}, onProgress, onError );
	
	})()

	//////////////////////////////////////////////////////////////////////////////////
	//		render the whole thing on the page
	//////////////////////////////////////////////////////////////////////////////////

	// handle window resize
	window.addEventListener('resize', function(){
		renderer.setSize( window.innerWidth, window.innerHeight )
		camera.aspect	= window.innerWidth / window.innerHeight
		camera.updateProjectionMatrix()
	}, false)

	
	// render the scene
	onRenderFcts.push(function(){	
		renderStats.begin();
		if( webglRenderEnabled === true ){
			renderer.render( scene, camera );
		}
		renderStats.end();
	})

	// run the rendering loop
	var previousTime = performance.now()
	requestAnimationFrame(function animate(now){

		requestAnimationFrame( animate );

		onRenderFcts.forEach(function(onRenderFct){
			onRenderFct(now, now - previousTime)
		})

		previousTime	= now
	})

	//////////////////////////////////////////////////////////////////////////////////
	//		Do the Augmented Reality part
	//////////////////////////////////////////////////////////////////////////////////


	// init the marker recognition
	var jsArucoMarker	= new THREEx.JsArucoMarker()
	var videoGrabbing = new THREEx.WebcamGrabbing()
	
	// attach the videoGrabbing.domElement to the body
        document.body.appendChild(videoGrabbing.domElement)

	//////////////////////////////////////////////////////////////////////////////////
	//		Process video source to find markers
	//////////////////////////////////////////////////////////////////////////////////
	// set the markerObject3D as visible
	markerObject3D.visible	= false
	// process the image source with the marker recognition
	onRenderFcts.push(function(){
		if( detectMarkersEnabled === false )	return
		
		var domElement	= videoGrabbing.domElement
		detectMarkersStats.begin();
		var markers	= jsArucoMarker.detectMarkers(domElement)
		detectMarkersStats.end();

		if( markerToObject3DEnabled === false )	return
		markerObject3D.visible = false

		// see if this.markerId has been found
		markers.forEach(function(marker){
			// if( marker.id !== 265 )	return

			jsArucoMarker.markerToObject3D(marker, markerObject3D)

			markerObject3D.visible = true
		})
	})
</script></body>
